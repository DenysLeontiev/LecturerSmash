name: Build & Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy TeachersRating
        uses: appleboy/ssh-action@v0.1.2
        with:
          host: ${{ secrets.SSH_HOST }}            # IP address of your server
          key: ${{ secrets.SSH_KEY }}              # Private SSH key for SSH login to droplet
          username: ${{ secrets.SSH_USERNAME }}    # SSH username (e.g., root)
          script: |
            echo "========== START DEPLOYMENT =========="
            echo "Initial working directory:"
            pwd
            echo "Initial directory contents:"
            ls -la

            echo "---------- Moving to home ----------"
            cd ~
            echo "Now in directory:"
            pwd
            echo "Contents of home directory:"
            ls -la

            echo "---------- Cleaning old deployment ----------"
            if [ -d "LecturerSmash" ]; then
              echo "LecturerSmash exists. Stopping containers and removing it..."
              cd LecturerSmash
              docker compose down || true
              cd ..
              rm -rf LecturerSmash
            else
              echo "No previous LecturerSmash folder found."
            fi

            echo "---------- Verifying SSH access to GitHub ----------"
            ssh -T git@github.com || true

            echo "---------- Cloning repository ----------"
            git clone git@github.com:DenysLeontiev/LecturerSmash.git

            echo "---------- Confirming clone location ----------"
            echo "Current directory:"
            pwd
            echo "Checking if LecturerSmash exists:"
            ls -la | grep LecturerSmash || echo "LecturerSmash not found!"
            echo "Full absolute path of LecturerSmash:"
            realpath LecturerSmash || echo "realpath command not available"

            echo "---------- Preparing sqlite directory ----------"
            cd LecturerSmash
            mkdir -p sqlite
            chmod 777 sqlite
            echo "sqlite directory prepared with full access permissions:"
            ls -ld sqlite

            echo "---------- Building and running containers ----------"
            docker compose build
            docker compose up -d

            echo "---------- Deployment complete ----------"
            echo "Currently in:"
            pwd
            echo "Running containers:"
            docker ps
            echo "========== DEPLOYMENT FINISHED =========="
